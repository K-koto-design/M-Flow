<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оценки.Образование</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 20px;
        }

        .app-container { max-width: 1100px; margin: 0 auto; }
        
        /* Авторизация */
        .auth-card {
            max-width: 400px; margin: 100px auto;
            background: var(--card); padding: 30px;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
        }

        input, select {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 2px solid var(--border); border-radius: 10px;
            font-size: 16px; outline: none; transition: 0.2s;
        }

        input:focus { border-color: var(--accent); }

        button {
            width: 100%; padding: 14px; margin-top: 10px;
            background: var(--accent); color: white;
            border: none; border-radius: 10px; font-weight: 700;
            cursor: pointer; transition: 0.3s;
        }

        button:hover { background: var(--accent-hover); transform: translateY(-1px); }

        /* Панели управления */
        .hidden { display: none; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Сетка Учителя (Excel style) */
        .journal-container {
            background: var(--card); border-radius: 15px;
            overflow-x: auto; border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); text-align: center; }
        th { background: #f1f5f9; font-weight: 800; color: #64748b; font-size: 13px; text-transform: uppercase; }
        
        .name-col { text-align: left; font-weight: 600; width: 250px; background: #fff; position: sticky; left: 0; z-index: 1; }
        
        .grade-badge {
            display: inline-block; width: 35px; height: 35px; line-height: 35px;
            border-radius: 8px; font-weight: 800; margin: 2px;
            position: relative; cursor: default;
        }

        .type-label {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            font-size: 8px; color: #94a3b8; background: white; padding: 0 2px;
        }

        /* Цвета оценок */
        .g-5 { background: #dcfce7; color: #15803d; }
        .g-4 { background: #f0fdf4; color: #16a34a; }
        .g-3 { background: #fef9c3; color: #a16207; }
        .g-2 { background: #fee2e2; color: #b91c1c; }

        .avg-box { font-weight: 800; color: var(--accent); font-size: 18px; }

        /* Конструктор ДЗ */
        .lesson-box {
            background: #eff6ff; padding: 20px; border-radius: 15px;
            margin-bottom: 25px; border: 1px dashed #bfdbfe;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div id="auth-section" class="auth-card">
        <h2 style="color: var(--accent);">Оценки.Образование</h2>
        <p>Электронный журнал будущего</p>
        <input type="email" id="email" placeholder="Email (например: teacher@mail.ru)">
        <input type="password" id="password" placeholder="Пароль">
        <select id="role-select">
            <option value="student">Я Ученик</option>
            <option value="teacher">Я Учитель</option>
        </select>
        <button onclick="handleAuth()">Войти в систему</button>
    </div>

    <div id="teacher-dash" class="hidden">
        <div class="dashboard-header">
            <div>
                <h1 id="teacher-title">Журнал класса</h1>
                <p id="teacher-email-sub" style="color: #64748b; margin-top: -10px;"></p>
            </div>
            <button onclick="logout()" style="width: auto; background: #94a3b8;">Выйти</button>
        </div>

        <div class="lesson-box">
            <h3>Проведение урока</h3>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 2;">
                    <label style="font-size: 12px; font-weight: 600;">Тема урока и ДЗ</label>
                    <input type="text" id="hw-input" placeholder="Напр: Тема 1. Глаголы. Стр 15 упр 2">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 12px; font-weight: 600;">Тип работ</label>
                    <select id="grade-type">
                        <option value="КЛ">Классная работа</option>
                        <option value="ДЗ">Домашняя работа</option>
                        <option value="КР">Контрольная</option>
                        <option value="СР">Самостоятельная</option>
                    </select>
                </div>
                <button onclick="publishLesson()" style="flex: 1; background: #059669;">Урок проведён</button>
            </div>
        </div>

        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <input type="text" id="new-student-name" placeholder="ФИО нового ученика" style="max-width: 300px;">
            <button onclick="addStudent()" style="width: auto;">Добавить в журнал</button>
        </div>

        <div class="journal-container">
            <table>
                <thead>
                    <tr id="table-head">
                        <th class="name-col">ФИО Ученика</th>
                        <th>Средний балл</th>
                        <th>Оценки</th>
                        <th>Действие</th>
                    </tr>
                </thead>
                <tbody id="teacher-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="student-dash" class="hidden">
        <div class="dashboard-header">
            <h1 id="student-name-display">Дневник</h1>
            <button onclick="logout()" style="width: auto; background: #94a3b8;">Выйти</button>
        </div>

        <div id="student-hw-card" style="background: var(--accent); color: white; padding: 25px; border-radius: 20px; margin-bottom: 30px;">
            <span style="opacity: 0.8; font-size: 14px;">ТЕКУЩЕЕ ЗАДАНИЕ</span>
            <h2 id="st-hw-text" style="margin: 10px 0;">Заданий пока нет</h2>
            <small id="st-hw-date"></small>
        </div>

        <h3>Мои успехи</h3>
        <div style="display: flex; align-items: center; gap: 20px; background: white; padding: 20px; border-radius: 15px; border: 1px solid var(--border);">
            <div class="avg-box" id="st-avg-display" style="font-size: 40px;">0.00</div>
            <div id="st-grades-strip" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>
    </div>
</div>

<script>
    // --- КОНФИГУРАЦИЯ FIREBASE ---
    const firebaseConfig = {
        apiKey: "API_KEY",
        authDomain: "PROJECT_ID.firebaseapp.com",
        databaseURL: "https://PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "PROJECT_ID",
        storageBucket: "PROJECT_ID.appspot.com",
        messagingSenderId: "ID",
        appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- ЛОГИКА АВТОРИЗАЦИИ ---
    function handleAuth() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role-select').value;

        auth.signInWithEmailAndPassword(email, password).catch(err => {
            if (err.code === 'auth/user-not-found') {
                auth.createUserWithEmailAndPassword(email, password).then(res => {
                    db.ref('users/' + res.user.uid).set({ email, role });
                });
            } else { alert(err.message); }
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).once('value').then(snap => {
                const data = snap.val();
                document.getElementById('auth-section').classList.add('hidden');
                if (data.role === 'teacher') initTeacher(user, data);
                else initStudent(user, data);
            });
        }
    });

    function logout() { auth.signOut(); location.reload(); }

    // --- ФУНКЦИИ УЧИТЕЛЯ ---
    function initTeacher(user, data) {
        document.getElementById('teacher-dash').classList.remove('hidden');
        document.getElementById('teacher-email-sub').innerText = `Преподаватель: ${data.email}`;
        
        // Слушаем изменения в базе в реальном времени
        db.ref('students').on('value', snap => {
            const students = snap.val();
            const tbody = document.getElementById('teacher-table-body');
            tbody.innerHTML = '';

            for (let id in students) {
                const s = students[id];
                const gradesArr = s.grades ? Object.values(s.grades) : [];
                const sum = gradesArr.reduce((a, b) => a + parseInt(b.val), 0);
                const avg = gradesArr.length ? (sum / gradesArr.length).toFixed(2) : "0.00";

                let gradesHtml = gradesArr.map(g => `
                    <div class="grade-badge g-${g.val}">
                        <span class="type-label">${g.type}</span>${g.val}
                    </div>
                `).join('');

                tbody.innerHTML += `
                    <tr>
                        <td class="name-col">${s.name}</td>
                        <td class="avg-box">${avg}</td>
                        <td>${gradesHtml}</td>
                        <td><button onclick="addGrade('${id}')" style="padding: 5px 10px; font-size:12px;">+ Оценка</button></td>
                    </tr>
                `;
            }
        });
    }

    function addStudent() {
        const name = document.getElementById('new-student-name').value;
        if (!name) return;
        db.ref('students').push({ name: name, grades: "" });
        document.getElementById('new-student-name').value = '';
    }

    function addGrade(studentId) {
        const val = prompt("Введите оценку (2, 3, 4, 5):");
        const type = document.getElementById('grade-type').value;
        if (['2','3','4','5'].includes(val)) {
            db.ref(`students/${studentId}/grades`).push({ val, type, date: Date.now() });
        }
    }

    function publishLesson() {
        const text = document.getElementById('hw-input').value;
        if (!text) return;
        db.ref('homework').set({
            text: text,
            date: new Date().toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })
        });
        alert("Информация обновлена у всех учеников!");
    }

    // --- ФУНКЦИИ УЧЕНИКА ---
    function initStudent(user, data) {
        document.getElementById('student-dash').classList.remove('hidden');
        
        // Получаем ДЗ в реальном времени
        db.ref('homework').on('value', snap => {
            const hw = snap.val();
            if (hw) {
                document.getElementById('st-hw-text').innerText = hw.text;
                document.getElementById('st-hw-date').innerText = "Опубликовано: " + hw.date;
            }
        });

        // Получаем свои оценки (поиск по Email для примера связки)
        db.ref('students').on('value', snap => {
            const students = snap.val();
            for (let id in students) {
                // Если имя ученика в журнале совпадает с началом email (упрощенно)
                if (user.email.includes(students[id].name.toLowerCase()) || students[id].name === user.email) {
                    const s = students[id];
                    const gradesArr = s.grades ? Object.values(s.grades) : [];
                    const sum = gradesArr.reduce((a, b) => a + parseInt(b.val), 0);
                    
                    document.getElementById('st-avg-display').innerText = gradesArr.length ? (sum / gradesArr.length).toFixed(2) : "0.00";
                    document.getElementById('st-grades-strip').innerHTML = gradesArr.map(g => `
                        <div class="grade-badge g-${g.val}">
                            <span class="type-label" style="background:#f8fafc">${g.type}</span>${g.val}
                        </div>
                    `).join('');
                }
            }
        });
    }
</script>

</body>
</html>
