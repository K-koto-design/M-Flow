<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-Flow Music</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --accent: #ff3366;
            --bg: #ffffff;
            --text: #000000;
            --glass: rgba(255, 255, 255, 0.8);
            --subtext: #8e8e93;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è --- */
        #auth-screen {
            position: fixed; inset: 0; background: #fff; z-index: 5000;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .auth-card { width: 80%; max-width: 320px; }
        .auth-card h1 { font-size: 28px; margin-bottom: 30px; }
        .auth-input {
            width: 100%; padding: 15px; margin: 10px 0; border: none;
            background: #f2f2f7; border-radius: 12px; font-size: 16px; box-sizing: border-box;
        }
        .btn-main {
            width: 100%; padding: 15px; border: none; background: #000;
            color: #fff; border-radius: 12px; font-weight: 600; margin-top: 20px;
        }

        /* --- –®–∞–ø–∫–∞ --- */
        header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: var(--glass); backdrop-filter: blur(10px); z-index: 100;
        }
        .tabs { display: flex; gap: 20px; font-weight: 600; color: var(--subtext); }
        .tab.active { color: var(--text); border-bottom: 2px solid var(--text); }

        /* --- –ö–æ–Ω—Ç–µ–Ω—Ç --- */
        .content { padding: 0 15px 120px; }
        .section-title { font-size: 22px; font-weight: 700; margin: 25px 0 15px; }
        
        /* –ü–ª–µ–π–ª–∏—Å—Ç—ã —Å–≤–µ—Ä—Ö—É */
        .horizontal-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .playlist-card { 
            min-width: 140px; background: #f9f9f9; padding: 12px; border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .playlist-card img { width: 100%; border-radius: 10px; }
        .playlist-card div { margin-top: 8px; font-weight: 600; font-size: 14px; }

        /* –ë–æ–ª—å—à–æ–π –±–∞–Ω–Ω–µ—Ä –∞—Ä—Ç–∏—Å—Ç–∞ */
        .artist-banner {
            position: relative; width: 100%; border-radius: 20px; overflow: hidden; margin-top: 20px;
        }
        .artist-banner img { width: 100%; display: block; }
        .banner-info {
            position: absolute; bottom: 20px; left: 20px; color: #fff;
        }
        .btn-play-banner {
            background: #fff; color: #000; padding: 10px 20px; border-radius: 20px;
            font-weight: 700; border: none; margin-top: 10px; display: flex; align-items: center; gap: 8px;
        }

        /* --- –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä --- */
        #mini-player {
            position: fixed; bottom: 75px; left: 10px; right: 10px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            padding: 10px 15px; border-radius: 15px; display: none;
            align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 900;
        }
        #mini-player img { width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; }
        .mini-info { flex: 1; overflow: hidden; }
        .mini-info b { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }
        .mini-info span { font-size: 12px; color: var(--subtext); }

        /* --- –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä (–≠–∫—Ä–∞–Ω) --- */
        #full-player {
            position: fixed; inset: 0; background: #fff; z-index: 2000;
            display: none; flex-direction: column; transition: transform 0.4s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }
        .player-bg {
            position: absolute; inset: 0; z-index: -1; filter: blur(60px) brightness(0.8); opacity: 0.5;
        }
        .player-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .main-cover-container {
            flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .main-cover {
            width: 100%; max-width: 320px; aspect-ratio: 1; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); object-fit: cover;
        }
        
        .track-desc { padding: 0 30px; display: flex; align-items: center; justify-content: space-between; }
        .track-desc h2 { margin: 0; font-size: 22px; }
        .track-desc p { margin: 5px 0 0; color: var(--subtext); }

        .controls { padding: 30px; }
        .progress-container { margin-bottom: 20px; }
        .progress-bar {
            width: 100%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; position: relative;
        }
        .progress-fill { height: 100%; background: #000; width: 0%; border-radius: 2px; }
        .time-info { display: flex; justify-content: space-between; font-size: 12px; margin-top: 8px; color: var(--subtext); }

        .main-btns { display: flex; justify-content: space-around; align-items: center; }
        .btn-circle {
            width: 70px; height: 70px; background: #000; color: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 30px; border: none;
        }
        .btn-icon { background: none; border: none; font-size: 24px; color: #000; opacity: 0.8; }

        /* –¢–µ–∫—Å—Ç –ø–µ—Å–µ–Ω */
        #lyrics-screen {
            position: absolute; inset: 0; background: inherit; display: none;
            padding: 60px 30px; text-align: left; overflow-y: auto; z-index: 10;
        }
        .lyric-line {
            font-size: 28px; font-weight: 700; color: rgba(0,0,0,0.2); margin: 20px 0; transition: 0.3s;
        }
        .lyric-line.active { color: #000; transform: scale(1.05); }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--glass);
            backdrop-filter: blur(15px); display: flex; justify-content: space-around;
            padding: 15px 0 25px; border-top: 1px solid rgba(0,0,0,0.05); z-index: 800;
        }
        .nav-item { text-align: center; font-size: 22px; color: var(--subtext); cursor: pointer; }
        .nav-item.active { color: #000; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1>Music Flow</h1>
            <input type="text" id="auth-user" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="auth-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-main" onclick="login()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <header>
        <div class="tabs">
            <div class="tab">–ò—Ç–æ–≥–∏ –≥–æ–¥–∞</div>
            <div class="tab active">–î–ª—è –≤–∞—Å</div>
            <div class="tab">–¢—Ä–µ–Ω–¥—ã</div>
        </div>
        <div style="font-size: 20px;">üîç</div>
    </header>

    <div class="content" id="home-content">
        <div class="horizontal-scroll">
            <div class="playlist-card">
                <img src="https://img.freepik.com/free-photo/glowing-lines-human-heart-shape-dark-background-generative-ai_191095-629.jpg">
                <div>–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è</div>
                <small id="fav-count">0 —Ç—Ä–µ–∫–æ–≤</small>
            </div>
            <div class="playlist-card">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR3y6kI9S7tH1m_p7e5M8pM5vXm9k7p1L-SgQ&s">
                <div>–ò—Å—Ç–æ—Ä–∏—è</div>
                <small>–ù–µ–¥–∞–≤–Ω–∏–µ</small>
            </div>
        </div>

        <div class="section-title">–ê—Ä—Ç–∏—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç</div>
        <div class="artist-banner">
            <img src="https://avatars.yandex.net/get-music-content/9833830/92042f05.a.26240032-1/m1000x1000">
            <div class="banner-info">
                <h3 style="margin:0; font-size:24px;">–†—É—Å—å</h3>
                <p style="margin:0; opacity:0.8;">–ü—Ä–æ–ø–∞–≥–∞–Ω–¥–∞</p>
                <button class="btn-play-banner">‚ñ∂ –°–ª—É—à–∞—Ç—å</button>
            </div>
        </div>

        <div class="section-title">–í–∞—à–∞ –ø–æ–¥–±–æ—Ä–∫–∞</div>
        <div id="track-list">
            </div>
    </div>

    <div id="mini-player" onclick="toggleFullPlayer(true)">
        <img id="mini-img" src="">
        <div class="mini-info">
            <b id="mini-title">–ü–µ—Å–Ω—è</b>
            <span id="mini-artist">–ê—Ä—Ç–∏—Å—Ç</span>
        </div>
        <div style="font-size: 24px; margin-right: 15px;">‚ù§Ô∏è</div>
        <div id="mini-play-btn" style="font-size: 28px;">‚ñ∂</div>
    </div>

    <div id="full-player">
        <div class="player-bg" id="p-blur-bg"></div>
        <div class="player-header">
            <span onclick="toggleFullPlayer(false)" style="font-size: 24px;">‚åÑ</span>
            <div style="text-align:center; font-size: 12px; font-weight: 600;">
                <span style="opacity:0.5">–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç</span><br>
                –ü–ª–µ–π–ª–∏—Å—Ç ¬´–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è¬ª
            </div>
            <span style="font-size: 24px;">‚ãÆ</span>
        </div>

        <div class="main-cover-container" id="cover-view">
            <img id="p-main-img" class="main-cover" src="">
        </div>

        <div id="lyrics-screen"></div>

        <div class="track-desc">
            <div>
                <h2 id="p-main-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
                <p id="p-main-artist">–ê—Ä—Ç–∏—Å—Ç</p>
            </div>
            <div style="font-size: 28px; display: flex; gap: 20px;">
                <span style="opacity: 0.6;">üì§</span>
                <span>‚ãÆ</span>
            </div>
        </div>

        <div class="controls">
            <div class="progress-container">
                <div class="progress-bar" onclick="seek(event)">
                    <div class="progress-fill" id="p-fill"></div>
                </div>
                <div class="time-info">
                    <span id="time-cur">0:00</span>
                    <span id="time-dur">0:00</span>
                </div>
            </div>

            <div class="main-btns">
                <button class="btn-icon">üö´</button>
                <button class="btn-icon">‚èÆ</button>
                <button class="btn-circle" id="p-play-btn" onclick="togglePlay()">II</button>
                <button class="btn-icon">‚è≠</button>
                <button class="btn-icon">‚ù§Ô∏è</button>
            </div>

            <div style="display: flex; justify-content: space-around; margin-top: 40px; opacity: 0.5; font-size: 20px;">
                <span>üîÅ</span>
                <span>üéöÔ∏è</span>
                <span onclick="toggleLyrics()">üé§</span>
                <span>‚è∞</span>
                <span>üîÄ</span>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active">üéµ</div>
        <div class="nav-item">üìñ</div>
        <div class="nav-item" onclick="openUpload()">üì§</div> <div class="nav-item">üë§</div>
    </div>

    <script>
        // –¢–í–û–ò –î–ê–ù–ù–´–ï FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBXsLSl_6HNpLm3TqPTjkTRqo62gb2j968",
            authDomain: "m-flow-65777.firebaseapp.com",
            projectId: "m-flow-65777",
            storageBucket: "m-flow-65777.firebasestorage.app",
            messagingSenderId: "598827175490",
            appId: "1:598827175490:web:26618e76510f296f7267db"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let allTracks = [];
        let currentTrack = null;
        const audio = new Audio();

        // 1. –í—Ö–æ–¥
        async function login() {
            const user = document.getElementById('auth-user').value.toLowerCase().trim();
            const pass = document.getElementById('auth-pass').value;
            const email = `${user}@mflow.app`;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch {
                try {
                    await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(auth.currentUser.uid).set({ username: user, premium: false });
                } catch(e) { alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞"); }
            }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                loadTracks();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤
        async function loadTracks() {
            const snap = await db.collection('tracks').get();
            allTracks = snap.docs.map(doc => doc.data());
            document.getElementById('fav-count').innerText = `${allTracks.length} —Ç—Ä–µ–∫–æ–≤`;
            renderTracks();
        }

        function renderTracks() {
            const container = document.getElementById('track-list');
            container.innerHTML = allTracks.map(t => `
                <div class="track-item" onclick='playTrack(${JSON.stringify(t)})'>
                    <img src="${t.cover}">
                    <div style="flex:1">
                        <b>${t.title}</b><br>
                        <small style="color:#8e8e93">${t.artist}</small>
                    </div>
                    <div style="opacity:0.3">‚ãÆ</div>
                </div>
            `).join('');
        }

        // 3. –ü–ª–µ–µ—Ä –õ–æ–≥–∏–∫–∞
        function playTrack(t) {
            currentTrack = t;
            
            // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('mini-player').style.display = 'flex';
            document.getElementById('mini-title').innerText = t.title;
            document.getElementById('mini-artist').innerText = t.artist;
            document.getElementById('mini-img').src = t.cover;

            document.getElementById('p-main-title').innerText = t.title;
            document.getElementById('p-main-artist').innerText = t.artist;
            document.getElementById('p-main-img').src = t.cover;
            document.getElementById('p-blur-bg').style.backgroundImage = `url(${t.cover})`;

            // –ú—É–∑—ã–∫–∞
            audio.src = fixGDrive(t.audio);
            audio.play();
            document.getElementById('p-play-btn').innerText = 'II';

            // –¢–µ–∫—Å—Ç
            const lyriCont = document.getElementById('lyrics-screen');
            lyriCont.innerHTML = t.lyrics.map(l => `<div class="lyric-line">${l.txt}</div>`).join('');
        }

        function fixGDrive(url) {
            if (url.includes('drive.google.com')) {
                const id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1];
                return `https://docs.google.com/uc?export=download&id=${id}`;
            }
            return url;
        }

        function togglePlay() {
            if(audio.paused) { audio.play(); document.getElementById('p-play-btn').innerText = 'II'; }
            else { audio.pause(); document.getElementById('p-play-btn').innerText = '‚ñ∂'; }
        }

        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100;
            document.getElementById('p-fill').style.width = p + '%';
            document.getElementById('time-cur').innerText = formatTime(audio.currentTime);
            document.getElementById('time-dur').innerText = formatTime(audio.duration);

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
            if(currentTrack && currentTrack.lyrics) {
                const lines = document.querySelectorAll('.lyric-line');
                currentTrack.lyrics.forEach((l, i) => {
                    if(audio.currentTime >= l.t) {
                        lines.forEach(el => el.classList.remove('active'));
                        lines[i].classList.add('active');
                        if(document.getElementById('lyrics-screen').style.display === 'block') {
                            lines[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }
        };

        function formatTime(s) {
            if(isNaN(s)) return "0:00";
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function toggleFullPlayer(show) {
            const p = document.getElementById('full-player');
            p.style.display = show ? 'flex' : 'none';
        }

        function toggleLyrics() {
            const l = document.getElementById('lyrics-screen');
            const c = document.getElementById('cover-view');
            if(l.style.display === 'block') { l.style.display = 'none'; c.style.opacity = '1'; }
            else { l.style.display = 'block'; c.style.opacity = '0'; }
        }

        function openUpload() {
            const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏:");
            const artist = prompt("–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:");
            const cover = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É (URL):");
            const audioUrl = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 (Google Drive –∏–ª–∏ –ø—Ä—è–º–∞—è):");
            const lyrics = prompt("–¢–µ–∫—Å—Ç (—Ñ–æ—Ä–º–∞—Ç: —Å–µ–∫|—Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç)");
            
            if(title && audioUrl) {
                db.collection('tracks').add({
                    title, artist, cover, audio: audioUrl,
                    lyrics: [{t: 0, txt: lyrics}],
                    createdAt: Date.now()
                }).then(() => location.reload());
            }
        }
    </script>
</body>
</html>
