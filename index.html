<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-Flow Premium</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --subtext: #8e8e93;
            --glass: rgba(255, 255, 255, 0.85);
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è --- */
        #auth-screen {
            position: fixed; inset: 0; background: #fff; z-index: 5000;
            display: flex; align-items: center; justify-content: center;
        }
        .auth-card { width: 85%; max-width: 320px; text-align: center; }
        .auth-input {
            width: 100%; padding: 16px; margin: 10px 0; border: none;
            background: #f2f2f7; border-radius: 14px; font-size: 16px; box-sizing: border-box;
        }
        .btn-black {
            width: 100%; padding: 16px; border: none; background: #000;
            color: #fff; border-radius: 14px; font-weight: 600; margin-top: 15px;
        }

        /* --- –ö–æ–Ω—Ç–µ–Ω—Ç --- */
        header { padding: 20px; position: sticky; top: 0; background: var(--glass); backdrop-filter: blur(20px); z-index: 100; border-bottom: 0.5px solid #e5e5ea; }
        .content { padding: 15px 15px 150px; }
        .track-card {
            display: flex; align-items: center; padding: 12px;
            background: #f9f9fb; border-radius: 16px; margin-bottom: 12px; cursor: pointer;
        }
        .track-card img { width: 55px; height: 55px; border-radius: 10px; object-fit: cover; margin-right: 15px; background: #eee; }
        
        /* --- –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä --- */
        #mini-player {
            position: fixed; bottom: 85px; left: 10px; right: 10px;
            background: var(--glass); backdrop-filter: blur(30px);
            padding: 8px 15px; border-radius: 20px; display: none;
            align-items: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1); z-index: 900;
            border: 0.5px solid rgba(0,0,0,0.05);
        }
        #mini-player img { width: 40px; height: 40px; border-radius: 8px; margin-right: 12px; }

        /* --- –ü–û–õ–ù–´–ô –ü–õ–ï–ï–† (iOS Style) --- */
        #full-player {
            position: fixed; top: 100%; left: 0; right: 0; height: 100%;
            background: #fff; z-index: 2000; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
        }
        #full-player.active { transform: translateY(-100%); }

        .player-bg-blur {
            position: absolute; inset: 0; z-index: -1; 
            background-size: cover; background-position: center;
            filter: blur(80px) brightness(0.9); opacity: 0.4;
        }

        .player-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { font-size: 30px; cursor: pointer; padding: 5px; }

        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .cover-wrap { width: 100%; max-width: 300px; position: relative; }
        .cover-img { width: 100%; aspect-ratio: 1; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); object-fit: cover; background: #eee; }

        .lyrics-container {
            position: absolute; inset: 0; display: none; flex-direction: column;
            overflow-y: auto; padding: 20px; text-align: left; scroll-behavior: smooth;
        }
        .lyric-line { font-size: 24px; font-weight: 800; color: rgba(0,0,0,0.2); margin: 15px 0; transition: 0.3s; }
        .lyric-line.active { color: #000; transform: scale(1.05); }

        .track-info { width: 100%; padding: 20px 0; text-align: left; }
        .track-info h2 { margin: 0; font-size: 22px; font-weight: 700; }
        .track-info p { margin: 5px 0; color: var(--subtext); font-size: 18px; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
        .progress-area { width: 100%; margin-top: 10px; }
        .bar-bg { width: 100%; height: 5px; background: rgba(0,0,0,0.1); border-radius: 5px; position: relative; cursor: pointer; }
        .bar-fill { height: 100%; background: #000; border-radius: 5px; width: 0%; }
        .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--subtext); margin-top: 8px; }

        .player-controls { display: flex; align-items: center; justify-content: space-around; width: 100%; margin-top: 20px; }
        .play-btn-big { width: 75px; height: 75px; background: #000; color: #fff; border-radius: 50%; border: none; font-size: 30px; display: flex; align-items: center; justify-content: center; }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--glass); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 15px 0 30px; border-top: 0.5px solid #e5e5ea; }
        .nav-item { font-size: 24px; opacity: 0.4; }
        .nav-item.active { opacity: 1; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="font-size: 32px; letter-spacing: -1px;">M-Flow</h1>
            <input type="text" id="user-login" class="auth-input" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="user-pass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-black" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <header>
        <b style="font-size: 20px;">–î–ª—è –≤–∞—Å</b>
    </header>

    <div class="content" id="track-list">
        <p style="text-align:center; color:#888;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤...</p>
    </div>

    <div id="mini-player" onclick="openFullPlayer()">
        <img id="m-img" src="">
        <div style="flex:1; overflow:hidden;">
            <b id="m-title" style="font-size:14px; white-space:nowrap;"></b><br>
            <span id="m-artist" style="font-size:12px; color:#888;"></span>
        </div>
        <button onclick="event.stopPropagation(); togglePlay();" id="m-play-btn" style="background:none; border:none; font-size:24px;">‚ñ∂</button>
    </div>

    <div id="full-player">
        <div class="player-bg-blur" id="p-blur"></div>
        <div class="player-header">
            <span class="close-btn" onclick="closeFullPlayer()">‚åÑ</span>
            <div style="text-align:center; font-size:12px;"><b>–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç</b></div>
            <span style="font-size:20px;">‚ãÆ</span>
        </div>

        <div class="main-content">
            <div class="cover-wrap">
                <img id="p-img" class="cover-img" src="">
                <div id="lyrics-layer" class="lyrics-container"></div>
            </div>

            <div class="track-info">
                <h2 id="p-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
                <p id="p-artist">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</p>
                
                <div class="progress-area">
                    <div class="bar-bg" onclick="seek(event)">
                        <div class="bar-fill" id="p-fill"></div>
                    </div>
                    <div class="time-labels">
                        <span id="t-cur">0:00</span>
                        <span id="t-dur">0:00</span>
                    </div>
                </div>
            </div>

            <div class="player-controls">
                <span style="font-size:25px;">üîÄ</span>
                <span style="font-size:35px;">‚èÆ</span>
                <button class="play-btn-big" onclick="togglePlay()" id="p-play-btn">‚ñ∂</button>
                <span style="font-size:35px;">‚è≠</span>
                <span onclick="toggleLyrics()" style="font-size:25px;">üé§</span>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active">üè†</div>
        <div class="nav-item">üîç</div>
        <div class="nav-item" onclick="addNewTrack()">‚ûï</div>
        <div class="nav-item">üë§</div>
    </div>

    <script>
        // –ö–û–ù–§–ò–ì FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBXsLSl_6HNpLm3TqPTjkTRqo62gb2j968",
            authDomain: "m-flow-65777.firebaseapp.com",
            projectId: "m-flow-65777",
            storageBucket: "m-flow-65777.firebasestorage.app",
            messagingSenderId: "598827175490",
            appId: "1:598827175490:web:26618e76510f296f7267db"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const audio = new Audio();
        let tracks = [];
        let currentTrack = null;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function handleLogin() {
            const user = document.getElementById('user-login').value.trim().toLowerCase();
            const pass = document.getElementById('user-pass').value;
            if(!user || pass.length < 6) return alert("–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤)");
            
            const email = `${user}@mflow.app`;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch {
                try {
                    await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(auth.currentUser.uid).set({username: user});
                } catch(e) { alert("–û—à–∏–±–∫–∞!"); }
            }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                loadTracks();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞
        async function loadTracks() {
            const snap = await db.collection('tracks').orderBy('createdAt', 'desc').get();
            tracks = snap.docs.map(doc => doc.data());
            const list = document.getElementById('track-list');
            list.innerHTML = tracks.map(t => `
                <div class="track-card" onclick='initPlayer(${JSON.stringify(t)})'>
                    <img src="${t.cover || 'https://via.placeholder.com/150'}">
                    <div style="flex:1">
                        <b>${t.title}</b><br>
                        <span style="color:#888; font-size:14px;">${t.artist}</span>
                    </div>
                    <span>‚ô°</span>
                </div>
            `).join('');
        }

        // –ü–ª–µ–µ—Ä –õ–æ–≥–∏–∫–∞
        function initPlayer(t) {
            currentTrack = t;
            audio.src = fixUrl(t.audio);
            audio.play();
            
            // –ú–∏–Ω–∏ –ø–ª–µ–µ—Ä
            document.getElementById('mini-player').style.display = 'flex';
            document.getElementById('m-title').innerText = t.title;
            document.getElementById('m-artist').innerText = t.artist;
            document.getElementById('m-img').src = t.cover;

            // –ü–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä
            document.getElementById('p-title').innerText = t.title;
            document.getElementById('p-artist').innerText = t.artist;
            document.getElementById('p-img').src = t.cover;
            document.getElementById('p-blur').style.backgroundImage = `url(${t.cover})`;
            document.getElementById('p-play-btn').innerText = 'II';
            document.getElementById('m-play-btn').innerText = 'II';

            // –¢–µ–∫—Å—Ç
            const lyrBox = document.getElementById('lyrics-layer');
            lyrBox.innerHTML = (t.lyrics || []).map(l => `<div class="lyric-line">${l.txt}</div>`).join('');
            
            openFullPlayer();
        }

        function fixUrl(url) {
            if(url.includes('drive.google.com')) {
                const id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1];
                return `https://docs.google.com/uc?export=download&id=${id}`;
            }
            return url;
        }

        function togglePlay() {
            if(audio.paused) {
                audio.play();
                document.getElementById('p-play-btn').innerText = 'II';
                document.getElementById('m-play-btn').innerText = 'II';
            } else {
                audio.pause();
                document.getElementById('p-play-btn').innerText = '‚ñ∂';
                document.getElementById('m-play-btn').innerText = '‚ñ∂';
            }
        }

        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100;
            document.getElementById('p-fill').style.width = p + '%';
            document.getElementById('t-cur').innerText = formatTime(audio.currentTime);
            document.getElementById('t-dur').innerText = formatTime(audio.duration);

            // –°–∏–Ω—Ö—Ä–æ–Ω —Ç–µ–∫—Å—Ç–∞
            if(currentTrack && currentTrack.lyrics) {
                const lines = document.querySelectorAll('.lyric-line');
                currentTrack.lyrics.forEach((l, i) => {
                    if(audio.currentTime >= l.t) {
                        lines.forEach(el => el.classList.remove('active'));
                        lines[i].classList.add('active');
                        lines[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }
        };

        function formatTime(s) {
            if(isNaN(s)) return "0:00";
            const m = Math.floor(s/60);
            const sc = Math.floor(s%60);
            return `${m}:${sc < 10 ? '0' : ''}${sc}`;
        }

        function seek(e) {
            const rect = e.target.closest('.bar-bg').getBoundingClientRect();
            const p = (e.clientX - rect.left) / rect.width;
            audio.currentTime = p * audio.duration;
        }

        function openFullPlayer() { document.getElementById('full-player').classList.add('active'); }
        function closeFullPlayer() { document.getElementById('full-player').classList.remove('active'); }
        
        function toggleLyrics() {
            const lyr = document.getElementById('lyrics-layer');
            const img = document.getElementById('p-img');
            if(lyr.style.display === 'flex') {
                lyr.style.display = 'none'; img.style.opacity = '1';
            } else {
                lyr.style.display = 'flex'; img.style.opacity = '0.1';
            }
        }

        // –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
        function addNewTrack() {
            const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞:");
            const artist = prompt("–ê—Ä—Ç–∏—Å—Ç:");
            const audioUrl = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 (Google Drive –∏–ª–∏ –ø—Ä—è–º–∞—è):");
            const coverUrl = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É (–ø—Ä—è–º–∞—è .jpg):");
            const lyrText = prompt("–¢–µ–∫—Å—Ç —á–µ—Ä–µ–∑ | (–ø—Ä–∏–º–µ—Ä: 10|–ö—É–ø–ª–µ—Ç 1)");

            if(title && audioUrl) {
                const lyrics = lyrText.split(',').map(item => {
                    const [t, txt] = item.split('|');
                    return {t: parseInt(t) || 0, txt: txt || item};
                });

                db.collection('tracks').add({
                    title, artist, cover: coverUrl, audio: audioUrl,
                    lyrics: lyrics, createdAt: Date.now()
                }).then(() => location.reload());
            }
        }
    </script>
</body>
</html>
