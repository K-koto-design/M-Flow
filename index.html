<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Flow Music</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #1DB954; --bg: #0b0b0b; --card: #1a1a1a; --text: #fff; --grey: #b3b3b3; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow-x: hidden; }
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--card); padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; box-sizing: border-box; outline: none; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #222; z-index: 1000; }
        .nav-btn { background: none; border: none; color: #888; font-size: 11px; cursor: pointer; text-align: center; }
        .nav-btn.active { color: var(--primary); }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; padding: 20px 20px 100px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        
        .track-item { display: flex; align-items: center; background: var(--card); padding: 10px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .track-item img { width: 50px; height: 50px; border-radius: 6px; margin-right: 15px; object-fit: cover; }
        
        /* –ü–ª–µ–µ—Ä */
        #player-modal { position: fixed; inset: 0; background: linear-gradient(to bottom, #222, #000); z-index: 1500; display: none; flex-direction: column; align-items: center; padding: 40px 25px; }
        .player-img { width: 100%; max-width: 300px; aspect-ratio: 1; border-radius: 15px; object-fit: cover; margin-top: 20px; }
        .lyrics-box { height: 200px; overflow-y: auto; margin: 20px 0; text-align: center; width: 100%; scroll-behavior: smooth; }
        .lyrics-box::-webkit-scrollbar { display: none; }
        .lyric-line { font-size: 18px; color: #555; padding: 10px 0; transition: 0.3s; }
        .lyric-line.active { color: #fff; font-weight: bold; transform: scale(1.1); }
        
        .btn { background: var(--primary); color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2>M-Flow Music</h2>
            <input type="text" id="login-user" placeholder="–í–∞—à –ª–æ–≥–∏–Ω">
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="handleAuth()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="page-home" class="page active">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞—Ä—Ç–∏—Å—Ç—É..." oninput="search()">
        <div id="track-list"></div>
    </div>

    <div id="page-upload" class="page">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –º—É–∑—ã–∫—É</h2>
        <input type="text" id="up-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏">
        <input type="text" id="up-artist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å">
        <input type="text" id="up-cover" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (URL)">
        <input type="text" id="up-audio" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 (URL)">
        <textarea id="up-lyrics" rows="5" placeholder="0|–ò–Ω—Ç—Ä–æ...&#10;15|–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞"></textarea>
        <button class="btn" onclick="saveToFirebase()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ç—Ä–µ–∫</button>
    </div>

    <div id="page-profile" class="page">
        <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <p>–õ–æ–≥–∏–Ω: <b id="display-name"></b></p>
        <p>–°—Ç–∞—Ç—É—Å: <span id="premium-status">–û–±—ã—á–Ω—ã–π</span></p>
        <button class="btn" style="background: #333; color: white;" onclick="auth.signOut()">–í—ã–π—Ç–∏</button>
    </div>

    <div id="player-modal">
        <button onclick="closePlayer()" style="align-self: flex-start; background: none; color: white; border: none; font-size: 30px;">‚úï</button>
        <img id="p-img" class="player-img" src="">
        <div id="p-lyrics" class="lyrics-box"></div>
        <h2 id="p-title" style="margin-bottom: 5px;"></h2>
        <p id="p-artist" style="color: var(--grey); margin-top: 0;"></p>
        <button id="dl-btn" class="btn" style="display:none; background: #222; color: white;" onclick="downloadSong()">üì• –°–∫–∞—á–∞—Ç—å MP3</button>
        <audio id="audio-player" controls style="width: 100%; margin-top: auto;"></audio>
    </div>

    <div class="nav">
        <div class="nav-btn active" onclick="showPage('page-home', this)">üè†<br>–ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-btn" onclick="showPage('page-upload', this)">‚ûï<br>–°–æ–∑–¥–∞—Ç—å</div>
        <div class="nav-btn" onclick="showPage('page-profile', this)">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBXsLSl_6HNpLm3TqPTjkTRqo62gb2j968",
            authDomain: "m-flow-65777.firebaseapp.com",
            projectId: "m-flow-65777",
            storageBucket: "m-flow-65777.firebasestorage.app",
            messagingSenderId: "598827175490",
            appId: "1:598827175490:web:26618e76510f296f7267db"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let allTracks = [];
        let currentTrack = null;
        let isPremium = false;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function handleAuth() {
            const user = document.getElementById('login-user').value.toLowerCase().trim();
            const pass = document.getElementById('login-pass').value;
            const email = `${user}@mflow.app`;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch {
                try {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(res.user.uid).set({ username: user, premium: false });
                } catch(e) { alert("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 –∑–Ω–∞–∫–æ–≤"); }
            }
        }

        auth.onAuthStateChanged(async user => {
            if(user) {
                document.getElementById('auth-screen').style.display = 'none';
                const doc = await db.collection('users').doc(user.uid).get();
                const data = doc.data();
                document.getElementById('display-name').innerText = data.username;
                isPremium = data.premium;
                document.getElementById('premium-status').innerText = isPremium ? "Premium üíé" : "–û–±—ã—á–Ω—ã–π";
                loadTracks();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ (–¢–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏)
        async function saveToFirebase() {
            const title = document.getElementById('up-title').value;
            const artist = document.getElementById('up-artist').value;
            const cover = document.getElementById('up-cover').value;
            const audio = document.getElementById('up-audio').value;
            const lyricsRaw = document.getElementById('up-lyrics').value;

            if(!title || !cover || !audio) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è —Å—Å—ã–ª–∫–∞–º–∏!");

            const lyrics = lyricsRaw.split('\n').filter(l => l.includes('|')).map(l => {
                const [t, txt] = l.split('|');
                return { t: parseInt(t), txt: txt.trim() };
            });

            await db.collection('tracks').add({ title, artist, cover, audio, lyrics, createdAt: Date.now() });
            alert("–¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!");
            location.reload();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä
        async function loadTracks() {
            const snap = await db.collection('tracks').orderBy('createdAt', 'desc').get();
            allTracks = snap.docs.map(doc => doc.data());
            render(allTracks);
        }

        function render(arr) {
            document.getElementById('track-list').innerHTML = arr.map(t => `
                <div class="track-item" onclick='openPlayer(${JSON.stringify(t)})'>
                    <img src="${t.cover}">
                    <div><b>${t.title}</b><br><small style="color:#888">${t.artist}</small></div>
                </div>
            `).join('');
        }

        function search() {
            const q = document.getElementById('search-input').value.toLowerCase();
            render(allTracks.filter(t => t.title.toLowerCase().includes(q) || t.artist.toLowerCase().includes(q)));
        }

        // –ü–ª–µ–µ—Ä
        const player = document.getElementById('audio-player');

        function openPlayer(t) {
            currentTrack = t;
            document.getElementById('player-modal').style.display = 'flex';
            document.getElementById('p-title').innerText = t.title;
            document.getElementById('p-artist').innerText = t.artist;
            document.getElementById('p-img').src = t.cover;
            document.getElementById('dl-btn').style.display = isPremium ? 'block' : 'none';
            player.src = t.audio;
            player.play();

            document.getElementById('p-lyrics').innerHTML = t.lyrics.map(l => `<div class="lyric-line">${l.txt}</div>`).join('');
        }

        player.ontimeupdate = () => {
            const time = Math.floor(player.currentTime);
            const lines = document.querySelectorAll('.lyric-line');
            currentTrack.lyrics.forEach((l, i) => {
                if(time >= l.t) {
                    lines.forEach(el => el.classList.remove('active'));
                    lines[i].classList.add('active');
                    lines[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        };

        async function downloadSong() {
            const res = await fetch(currentTrack.audio);
            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentTrack.title}.mp3`;
            a.click();
        }

        function showPage(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function closePlayer() { document.getElementById('player-modal').style.display = 'none'; player.pause(); }
    </script>
</body>
</html>
